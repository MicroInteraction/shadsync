<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ShadSync</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      background: white;
      color: #333333;
      padding: 0;
      margin: 0;
      height: 100vh;
      overflow: hidden;
    }

    .container {
      padding: 0;
      height: 100vh;
      overflow: hidden;
    }

    .card {
      background: white;
      border-radius: 0;
      padding: 12px;
      height: 100vh;
      overflow-y: auto;
      margin: 0;
    }

    .header {
      margin-bottom: 24px;
    }

    .logo {
      margin-bottom: 24px;
      display: flex;
      align-items: center;
    }

    .logo svg {
      width: 116px;
      height: 21px;
    }

    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 32px;
      background: #F5F5F5;
      border-radius: 12px;
      padding: 4px;
    }

    .tab {
      flex: 1;
      padding: 12px 16px;
      border: none;
      background: transparent;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s ease;
      color: #6B7280;
      text-align: center;
    }

    .tab.active {
      border: 1px solid #F2F2F2;
      background: #FFF;
      box-shadow: 0px 4px 4px -5px rgba(0, 0, 0, 0.10);
      color: #333333;
    }

    .tab:hover:not(.active) {
      background: #E5E7EB;
      color: #374151;
    }

    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333333;
    }

    .input-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #666666;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      background: #fafafa;
    }

    textarea::placeholder {
      color: #999999;
    }

    textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
    }

    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      font-size: 14px;
    }

    select:focus {
      outline: none;
      border-color: #ff6b35;
    }

    .button {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }

    .button-primary {
      background: #FF6C46;
      color: white;
    }

    .button-primary:hover {
      background: #E55A3A;
    }

    .button-secondary {
      background: #F8F9FA;
      color: #374151;
      border: 1px solid #E5E7EB;
    }

    .button-secondary:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .replace-btn {
      background: #FF6C46;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .replace-btn:hover {
      background: #E55A3A;
    }

    .replace-btn:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
    }

    .button-secondary:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 12px;
      line-height: 1.4;
      display: none;
    }

    .status.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }

    .status.error {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .variables-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
    }

    .variable-item {
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .variable-item:last-child {
      border-bottom: none;
    }

    .collection-group {
      margin-bottom: 16px;
    }

    .collection-title {
      font-weight: 600;
      color: #333333;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .hidden {
      display: none !important;
    }

    .tab-content {
      display: block;
    }

    .tab-content.hidden {
      display: none !important;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      margin: 0;
    }

    .checkbox-group label {
      margin: 0;
      font-size: 14px;
      text-transform: none;
      letter-spacing: normal;
      color: #333333;
    }

    .suggestion-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .object-info {
      font-size: 12px;
      color: #666;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .current-variable {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .suggestion-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .color-preview {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }

    .variable-name {
      flex: 1;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      color: #333;
    }

    .replace-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .replace-btn:hover {
      background: #ff5722;
    }

    .replace-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .no-suggestion {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }

    .suggestion-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .dropdown-suggestions {
      margin-top: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .dropdown-suggestions.show {
      display: block;
    }

    .dropdown-item {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .suggestion-score {
      font-size: 10px;
      color: #999;
      margin-left: auto;
    }

    .current-selection {
      background: #e3f2fd !important;
      color: #1976d2;
    }

    .select-dropdown {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .variable-group {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .variable-group-header {
      background: #fff3f0;
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .affected-objects {
      background: #fafafa;
      padding: 12px;
    }

    .object-item {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .object-item:last-child {
      border-bottom: none;
    }

    .group-replacement {
      margin-top: 12px;
    }

    .suggestion-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .object-info {
      font-size: 12px;
      color: #666;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .current-variable {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .suggestion-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .color-preview {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }

    .variable-name {
      flex: 1;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      color: #333;
    }

    .replace-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .replace-btn:hover {
      background: #ff5722;
    }

    .replace-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .no-suggestion {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }

    .suggestion-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .dropdown-suggestions {
      margin-top: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .dropdown-suggestions.show {
      display: block;
    }

    .dropdown-item {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .suggestion-score {
      font-size: 10px;
      color: #999;
      margin-left: auto;
    }

    .current-selection {
      background: #e3f2fd !important;
      color: #1976d2;
    }

    .select-dropdown {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }
    
    /* Modern Detect Interface Styles */
    .scan-section {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .scan-title {
      font-size: 18px;
      font-weight: 600;
      color: #1F2937;
    }

    .scan-actions {
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .scan-btn {
      background: #F8F9FA;
      color: #374151;
      border: 1px solid #E5E7EB;
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .scan-btn:hover {
      background: #F3F4F6;
      border-color: #D1D5DB;
    }

    .replace-all-btn {
      background: #FF6C46;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .replace-all-btn:hover {
      background: #E55A3A;
    }

    .replace-all-btn:disabled {
      background: #D1D5DB;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .replace-all-btn:disabled:hover {
      background: #D1D5DB;
    }

    /* Variable Group Styles */
    .variable-section {
      background: #F8F9FA;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .variable-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .variable-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1F2937;
    }

    .variable-count {
      background: #E5E7EB;
      color: #374151;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .variable-item {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid #E5E7EB;
    }

    .variable-item:last-child {
      margin-bottom: 0;
    }

    .variable-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .variable-color-preview {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 12px;
      border: 1px solid #E5E7EB;
    }

    .variable-name {
      font-weight: 600;
      color: #1F2937;
      font-size: 14px;
    }

    .variable-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .variable-dropdown {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #E5E7EB;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      color: #374151;
    }

    .variable-dropdown:focus {
      outline: none;
      border-color: #FF6C46;
      box-shadow: 0 0 0 2px rgba(255, 108, 70, 0.1);
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="logo">
          <svg width="116" height="21" viewBox="0 0 116 21" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16.608 7.984C16.608 10.288 16.112 12.256 15.12 13.888C14.128 15.52 12.736 16.768 10.944 17.632C9.152 18.496 7.072 18.928 4.704 18.928C3.568 18.928 2.48 18.832 1.44 18.64C0.4 18.464 0.176 18.416 0.176 18.416V0.879999H3.584V8.416C4.096 8.32 4.608 8.272 5.12 8.272C6.736 8.272 8.16 8.592 9.392 9.232C10.624 9.872 11.584 10.768 12.272 11.92C12.976 13.072 13.328 14.416 13.328 15.952C13.328 16.832 13.184 17.664 12.896 18.448H16.352C16.528 17.776 16.608 16.736 16.608 15.328V7.984ZM5.12 10.96C4.576 10.96 4.064 10.992 3.584 11.056V16.24C4.064 16.304 4.576 16.336 5.12 16.336C6.336 16.336 7.328 16.016 8.096 15.376C8.864 14.72 9.248 13.808 9.248 12.64C9.248 11.472 8.864 10.576 8.096 9.952C7.328 9.312 6.336 9.984 5.12 10.96ZM28.8156 8.56V18.64H25.4076V17.44C24.9276 17.984 24.3356 18.4 23.6316 18.688C22.9276 18.976 22.1596 19.12 21.3276 19.12C20.1596 19.12 19.1356 18.88 18.2556 18.4C17.3756 17.904 16.6956 17.216 16.2156 16.336C15.7356 15.44 15.4956 14.4 15.4956 13.216C15.4956 12.032 15.7356 11 16.2156 10.12C16.6956 9.224 17.3756 8.536 18.2556 8.056C19.1356 7.56 20.1596 7.312 21.3276 7.312C22.1596 7.312 22.9276 7.456 23.6316 7.744C24.3356 8.032 24.9276 8.448 25.4076 8.992V8.56H28.8156ZM21.8076 16.432C22.6396 16.432 23.3276 16.144 23.8716 15.568C24.4156 14.976 24.6876 14.192 24.6876 13.216C24.6876 12.24 24.4156 11.464 23.8716 10.888C23.3276 10.296 22.6396 10 21.8076 10C20.9756 10 20.2876 10.296 19.7436 10.888C19.1996 11.464 18.9276 12.24 18.9276 13.216C18.9276 14.192 19.1996 14.976 19.7436 15.568C20.2876 16.144 20.9756 16.432 21.8076 16.432ZM38.4529 8.56H41.8609V18.64H38.4529V17.44C37.9729 17.984 37.3809 18.4 36.6769 18.688C35.9729 18.976 35.2049 19.12 34.3729 19.12C33.2049 19.12 32.1809 18.88 31.3009 18.4C30.4209 17.904 29.7409 17.216 29.2609 16.336C28.7809 15.44 28.5409 14.4 28.5409 13.216C28.5409 12.032 28.7809 11 29.2609 10.12C29.7409 9.224 30.4209 8.536 31.3009 8.056C32.1809 7.56 33.2049 7.312 34.3729 7.312C35.2049 7.312 35.9729 7.456 36.6769 7.744C37.3809 8.032 37.9729 8.448 38.4529 8.992V8.56ZM34.8529 16.432C35.6849 16.432 36.3729 16.144 36.9169 15.568C37.4609 14.976 37.7329 14.192 37.7329 13.216C37.7329 12.24 37.4609 11.464 36.9169 10.888C36.3729 10.296 35.6849 10 34.8529 10C34.0209 10 33.3329 10.296 32.7889 10.888C32.2449 11.464 31.9729 12.24 31.9729 13.216C31.9729 14.192 32.2449 14.976 32.7889 15.568C33.3329 16.144 34.0209 16.432 34.8529 16.432ZM49.1622 19.12C47.8982 19.12 46.7782 18.88 45.8022 18.4C44.8262 17.904 44.0582 17.216 43.4982 16.336C42.9542 15.44 42.6822 14.4 42.6822 13.216C42.6822 12.032 42.9542 11 43.4982 10.12C44.0582 9.224 44.8262 8.536 45.8022 8.056C46.7782 7.56 47.8982 7.312 49.1622 7.312C50.4262 7.312 51.5462 7.56 52.5222 8.056C53.4982 8.536 54.2582 9.224 54.8022 10.12C55.3622 11 55.6422 12.032 55.6422 13.216C55.6422 14.4 55.3622 15.44 54.8022 16.336C54.2582 17.216 53.4982 17.904 52.5222 18.4C51.5462 18.88 50.4262 19.12 49.1622 19.12ZM49.1622 16.432C49.9942 16.432 50.6822 16.144 51.2262 15.568C51.7702 14.976 52.0422 14.192 52.0422 13.216C52.0422 12.24 51.7702 11.464 51.2262 10.888C50.6822 10.296 49.9942 10 49.1622 10C48.3302 10 47.6422 10.296 47.0982 10.888C46.5542 11.464 46.2822 12.24 46.2822 13.216C46.2822 14.192 46.5542 14.976 47.0982 15.568C47.6422 16.144 48.3302 16.432 49.1622 16.432ZM66.3196 7.312C67.4396 7.312 68.3996 7.56 69.1996 8.056C69.9996 8.536 70.6076 9.216 71.0236 10.096C71.4396 10.976 71.6476 12.008 71.6476 13.192C71.6476 14.376 71.4396 15.416 71.0236 16.312C70.6076 17.192 69.9996 17.872 69.1996 18.352C68.3996 18.832 67.4396 19.072 66.3196 19.072C65.5356 19.072 64.8236 18.944 64.1836 18.688C63.5436 18.416 62.9996 18.032 62.5516 17.536V22.16H59.1436V8.56H62.5516V9.76C62.9996 9.264 63.5436 8.888 64.1836 8.632C64.8236 8.36 65.5356 8.224 66.3196 8.224V7.312ZM65.8396 16.432C66.6716 16.432 67.3596 16.144 67.9036 15.568C68.4476 14.976 68.7196 14.192 68.7196 13.216C68.7196 12.24 68.4476 11.464 67.9036 10.888C67.3596 10.296 66.6716 10 65.8396 10C65.0076 10 64.3196 10.296 63.7756 10.888C63.2316 11.464 62.9596 12.24 62.9596 13.216C62.9596 14.192 63.2316 14.976 63.7756 15.568C64.3196 16.144 65.0076 16.432 65.8396 16.432ZM80.6011 19.12C79.3371 19.12 78.2171 18.88 77.2411 18.4C76.2651 17.904 75.4971 17.216 74.9371 16.336C74.3931 15.44 74.1211 14.4 74.1211 13.216C74.1211 12.032 74.3931 11 74.9371 10.12C75.4971 9.224 76.2651 8.536 77.2411 8.056C78.2171 7.56 79.3371 7.312 80.6011 7.312C81.8651 7.312 82.9851 7.56 83.9611 8.056C84.9371 8.536 85.6971 9.224 86.2411 10.12C86.8011 11 87.0811 12.032 87.0811 13.216C87.0811 14.4 86.8011 15.44 86.2411 16.336C85.6971 17.216 84.9371 17.904 83.9611 18.4C82.9851 18.88 81.8651 19.12 80.6011 19.12ZM80.6011 16.432C81.4331 16.432 82.1211 16.144 82.6651 15.568C83.2091 14.976 83.4811 14.192 83.4811 13.216C83.4811 12.24 83.2091 11.464 82.6651 10.888C82.1211 10.296 81.4331 10 80.6011 10C79.7691 10 79.0811 10.296 78.5371 10.888C77.9931 11.464 77.7211 12.24 77.7211 13.216C77.7211 14.192 77.9931 14.976 78.5371 15.568C79.0811 16.144 79.7691 16.432 80.6011 16.432ZM96.8584 7.312C98.4424 7.312 99.7224 7.744 100.698 8.608C101.69 9.472 102.186 10.696 102.186 12.28V18.64H98.7784V12.76C98.7784 11.976 98.5784 11.384 98.1784 10.984C97.7784 10.584 97.2184 10.384 96.4984 10.384C95.7784 10.384 95.2184 10.584 94.8184 10.984C94.4184 11.384 94.2184 11.976 94.2184 12.76V18.64H90.8104V8.56H94.2184V9.76C94.6984 9.216 95.2904 8.8 95.9944 8.512C96.6984 8.224 97.4504 8.08 98.2504 8.08L96.8584 7.312ZM115.229 7.312C116.301 7.312 117.213 7.552 117.965 8.032C118.717 8.512 119.285 9.184 119.669 10.048C120.069 10.912 120.269 11.928 120.269 13.096C120.269 13.32 120.253 13.552 120.221 13.792C120.205 14.016 120.173 14.224 120.125 14.416H108.701C108.797 15.296 109.157 15.984 109.781 16.48C110.421 16.976 111.245 17.224 112.253 17.224C112.925 17.224 113.517 17.128 114.029 16.936C114.557 16.744 115.013 16.472 115.397 16.12L116.885 18.208C116.293 18.8 115.541 19.256 114.629 19.576C113.717 19.896 112.717 20.056 111.629 20.056C110.269 20.056 109.093 19.816 108.101 19.336C107.125 18.856 106.365 18.176 105.821 17.296C105.293 16.416 105.029 15.384 105.029 14.2C105.029 13.032 105.285 12.008 105.797 11.128C106.325 10.232 107.053 9.544 107.981 9.064C108.925 8.568 109.997 8.32 111.197 8.32C112.365 8.32 113.405 8.56 114.317 9.04C115.245 9.52 115.965 10.2 116.477 11.08C116.989 11.944 117.245 12.968 117.245 14.152C117.245 14.632 117.197 15.072 117.101 15.472H111.725C111.725 14.976 111.861 14.568 112.133 14.248C112.405 13.928 112.765 13.768 113.213 13.768C113.661 13.768 114.021 13.928 114.293 14.248C114.565 14.568 114.701 14.976 114.701 15.472H115.229V7.312Z" fill="#0F172A"/>
          </svg>
        </div>
        <div class="tabs">
          <button class="tab active" data-tab="update">Update Theme</button>
          <button class="tab" data-tab="detect">Detect</button>
        </div>
      </div>

  <!-- Update Theme Tab -->
  <div id="update-tab" class="tab-content">
    <div class="section">
      <label for="css-input">Paste CSS</label>
      <textarea 
        id="css-input" 
        placeholder=":root {
  --background: #f9f9fa;
  --foreground: #333333;
  --card: #ffffff;
  --card-foreground: #333333;
  --popover: #ffffff;
  --primary: 220 80% 60%;
  --primary-foreground: #ffffff;
}"
      ></textarea>
    </div>

    <div class="input-group">
      <label>Collection</label>
      <div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; color: #666; font-size: 14px;">
        shadsync theme
      </div>
    </div>

    <div class="status" id="status"></div>

    <button class="button button-primary" id="update-variables">
      Update Variables
    </button>
  </div>

  <!-- Detect Tab -->
  <div id="detect-tab" class="tab-content hidden">
    <div class="scan-section">
      <div class="scan-title">Detect</div>
      <div class="scan-actions">
        <button class="scan-btn" id="check-variables">Scan</button>
        <button class="replace-all-btn" id="replace-all-btn" disabled>Replace All</button>
      </div>
    </div>
    
    <div id="variables-result" class="hidden">
      <!-- Non-ShadSync Variables Section -->
      <div id="non-shadsync-section" class="hidden">
        <div id="non-shadsync-list"></div>
      </div>
      
      <!-- All Variable-Assigned Objects Section -->
      <div id="all-variables-section" class="hidden">
        <div id="all-variables-list"></div>
      </div>
      
      <!-- Unassigned Objects Section -->
      <div id="unassigned-section" class="hidden">
        <div id="unassigned-list"></div>
      </div>
      
      <!-- Usage Summary Section -->
      <div id="usage-summary" class="hidden"></div>
      
      <!-- All Clear Message -->
      <div id="all-clear-message" class="hidden">
        <div style="text-align: center; padding: 40px; color: #6B7280;">
          No variables found from other collections. All good! ‚úÖ
        </div>
      </div>
    </div>
        
        <!-- Non-ShadSync Variables Section -->
        <div id="non-shadsync-section" class="hidden">
          <div class="section-title" style="color: #ff6b35;">‚ö†Ô∏è Variables from Other Collections</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            These variables from other collections are being used. Replace them with shadsync theme variables:
          </p>
          
          <div class="suggestion-list" id="non-shadsync-list"></div>
        </div>
        
        <!-- All Variable-Assigned Objects Section -->
        <div id="all-variables-section" class="hidden">
          <div class="section-title" style="color: #2196f3;">üîÑ All Variable-Assigned Objects</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            All objects using variables (from any collection). Review and replace with better shadsync theme options:
          </p>
          <div class="suggestion-list" id="all-variables-list"></div>
        </div>
        
        <!-- Unassigned Objects Section -->
        <div id="unassigned-section" class="hidden">
          <div class="section-title" style="color: #999;">Objects Without Variables</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            These objects have colors but no variables assigned:
          </p>
          <div class="suggestion-list" id="unassigned-list"></div>
        </div>
        
        <!-- Current Usage Summary -->
        <div id="usage-summary" class="hidden">
          <div class="section-title" style="color: #4caf50;">‚úÖ Current ShadSync Usage</div>
          <div id="variables-list"></div>
        </div>
        
        <!-- All Clear Message -->
        <div id="all-clear-message" class="hidden">
          <div style="text-align: center; padding: 24px; color: #4caf50;">
            <div style="font-size: 18px; margin-bottom: 8px;">üéâ</div>
            <div style="font-weight: 600; margin-bottom: 4px;">All Good!</div>
            <div style="font-size: 12px; color: #666;">All objects are using shadsync theme variables or have no variables assigned.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        
        // Show selected tab content
        const targetTab = document.getElementById(`${tabName}-tab`);
        if (targetTab) {
          targetTab.classList.remove('hidden');
        }
        
        // Clear status when switching tabs
        hideStatus();
      });
    });

    // Status message functions
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    // Update Variables
    document.getElementById('update-variables').addEventListener('click', () => {
      const css = document.getElementById('css-input').value.trim();
      
      if (!css) {
        showStatus('Please paste CSS variables first', 'error');
        return;
      }
      
      showStatus('Processing variables...', 'info');
      document.body.classList.add('loading');
      
      parent.postMessage({
        pluginMessage: {
          type: 'convert-css',
          css: css,
          collectionName: 'shadsync theme'
        }
      }, '*');
    });

    // Check Variables
    document.getElementById('check-variables').addEventListener('click', () => {
      showStatus('Scanning document for variables...', 'info');
      document.body.classList.add('loading');
      
      parent.postMessage({
        pluginMessage: {
          type: 'check-variables'
        }
      }, '*');
    });

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      document.body.classList.remove('loading');
      
      switch (msg.type) {
        case 'success':
          showStatus(msg.message, 'success');
          break;
          
        case 'error':
          showStatus(msg.message, 'error');
          break;
          
        case 'status':
          showStatus(msg.message, 'info');
          break;
          
        case 'variables-check-result':
          displayVariablesResult(msg.data);
          // Show scan summary
          const summary = msg.data.scanSummary;
          if (summary.nonShadSyncCount > 0) {
            showStatus(`Found ${summary.nonShadSyncCount} non-shadsync variable${summary.nonShadSyncCount !== 1 ? 's' : ''} in use`, 'error');
          } else if (summary.allVariableCount > 0) {
            showStatus(`Found ${summary.allVariableCount} variable${summary.allVariableCount !== 1 ? 's' : ''} in use (review for optimization)`, 'info');
          } else if (summary.unassignedCount > 0) {
            showStatus(`Found ${summary.unassignedCount} objects without variables assigned`, 'info');
          } else {
            showStatus('All objects are using shadsync theme variables! üéâ', 'success');
          }
          break;
      }
    };

    // Display variables check result
    function displayVariablesResult(data) {
      const resultDiv = document.getElementById('variables-result');
      
      // Show/hide sections based on data
      const nonShadSyncSection = document.getElementById('non-shadsync-section');
      const allVariablesSection = document.getElementById('all-variables-section');
      const unassignedSection = document.getElementById('unassigned-section');
      const usageSummarySection = document.getElementById('usage-summary');
      const allClearMessage = document.getElementById('all-clear-message');
      
      // Handle Replace All button state - enable if any variables can be replaced
      const replaceAllBtn = document.getElementById('replace-all-btn');
      const hasNonShadSync = data.nonShadSyncVariables && data.nonShadSyncVariables.length > 0;
      const hasAllVariablesWithSuggestions = data.allVariableAssigned && 
        data.allVariableAssigned.some(group => group.suggestion && group.suggestion.id);
      
      if (hasNonShadSync || hasAllVariablesWithSuggestions) {
        if (replaceAllBtn) {
          replaceAllBtn.disabled = false;
          replaceAllBtn.style.opacity = '1';
        }
      } else {
        if (replaceAllBtn) {
          replaceAllBtn.disabled = true;
          replaceAllBtn.style.opacity = '0.5';
        }
      }
      
      // Priority 1: Non-ShadSync Variables (most important)
      if (data.nonShadSyncVariables && data.nonShadSyncVariables.length > 0) {
        displayNonShadSyncVariables(data.nonShadSyncVariables);
        nonShadSyncSection.classList.remove('hidden');
      } else {
        nonShadSyncSection.classList.add('hidden');
      }
      
      // Priority 2: All Variable-Assigned Objects (for review and optimization)
      if (data.allVariableAssigned && data.allVariableAssigned.length > 0) {
        displayAllVariableAssigned(data.allVariableAssigned);
        allVariablesSection.classList.remove('hidden');
      } else {
        allVariablesSection.classList.add('hidden');
      }
      
      // Priority 3: Unassigned Objects (secondary)
      if (data.unassignedObjects && data.unassignedObjects.length > 0) {
        displayUnassignedObjects(data.unassignedObjects);
        unassignedSection.classList.remove('hidden');
      } else {
        unassignedSection.classList.add('hidden');
      }
      
      // Usage Summary (always show if we have shadsync variables being used)
      if (data.variablesByCollection && data.variablesByCollection['shadsync theme']) {
        displayUsageSummary(data.variablesByCollection, data.mainCollectionName);
        usageSummarySection.classList.remove('hidden');
      } else {
        usageSummarySection.classList.add('hidden');
      }
      
      // Show "All Clear" message if no issues found
      if ((!data.nonShadSyncVariables || data.nonShadSyncVariables.length === 0) && 
          (!data.unassignedObjects || data.unassignedObjects.length === 0)) {
        allClearMessage.classList.remove('hidden');
      } else {
        allClearMessage.classList.add('hidden');
      }
      
      resultDiv.classList.remove('hidden');
      
      // Set up Replace All button event listener
      setTimeout(() => {
        const replaceAllBtn = document.getElementById('replace-all-btn');
        if (replaceAllBtn) {
          replaceAllBtn.removeEventListener('click', window.replaceAllVariables);
          replaceAllBtn.addEventListener('click', window.replaceAllVariables);
        }
      }, 100);
      
      hideStatus();
    }
    
    // Display variables from non-shadsync collections (grouped by variable)
    function displayNonShadSyncVariables(nonShadSyncVariables) {
      const listDiv = document.getElementById('non-shadsync-list');
      let html = '';
      
      if (nonShadSyncVariables.length > 0) {
        html += `
          <div class="variable-section">
            <div class="variable-section-header">
              <div class="variable-section-title">Base</div>
              <div class="variable-count">${nonShadSyncVariables.length} variable${nonShadSyncVariables.length !== 1 ? 's' : ''}</div>
            </div>
        `;
        
        nonShadSyncVariables.forEach((variableGroup, groupIndex) => {
          const hasColor = variableGroup.objects && variableGroup.objects[0] && variableGroup.objects[0].color;
          const colorStyle = hasColor ? 
            `background: rgb(${Math.round((variableGroup.objects[0].color.r || 0) * 255)}, ${Math.round((variableGroup.objects[0].color.g || 0) * 255)}, ${Math.round((variableGroup.objects[0].color.b || 0) * 255)})` : 
            'background: #E5E7EB';
          
          html += `
            <div class="variable-item">
              <div class="variable-header">
                <div class="variable-color-preview" style="${colorStyle}"></div>
                <div class="variable-name">${variableGroup.currentVariable.name}</div>
              </div>
              <div class="variable-actions">
                <select class="variable-dropdown" id="select-group-${groupIndex}">
          `;
          
          // Add dropdown options
          if (variableGroup.allSuggestions && variableGroup.allSuggestions.length > 0) {
            variableGroup.allSuggestions.forEach(suggestion => {
              const selected = variableGroup.suggestion && suggestion.id === variableGroup.suggestion.id ? 'selected' : '';
              html += `<option value="${suggestion.id}" ${selected}>${suggestion.name} (${suggestion.score}% match)</option>`;
            });
          } else {
            html += '<option value="">No suggestions available</option>';
          }
          
          html += `
                </select>
                <button class="replace-btn" id="replace-btn-${groupIndex}" data-group-index="${groupIndex}" data-select-id="select-group-${groupIndex}">
                  Replace
                </button>
              </div>
            </div>
          `;
        });
        
        html += `</div>`;
      }
      
      listDiv.innerHTML = html;
      
      // Store the grouped data for replacement functionality
      window.nonShadSyncGroups = nonShadSyncVariables;
      
      // Show/hide the Replace All button
      const replaceAllBtn = document.getElementById('replace-all-btn');
      if (nonShadSyncVariables.length > 0) {
        replaceAllBtn.style.display = 'block';
      } else {
        replaceAllBtn.style.display = 'none';
      }
      
      // Add event listeners to replace buttons
      setTimeout(() => {
        nonShadSyncVariables.forEach((variableGroup, index) => {
          const button = document.getElementById(`replace-btn-${index}`);
          if (button) {
            button.addEventListener('click', function() {
              const buttonGroupIndex = parseInt(this.getAttribute('data-group-index'));
              const selectId = this.getAttribute('data-select-id');
              window.applyGroupReplacement(buttonGroupIndex, selectId);
            });
          }
        });
      }, 100);
    }
    
    // Display all variable-assigned objects for review and replacement
    function displayAllVariableAssigned(allVariableAssigned) {
      const listDiv = document.getElementById('all-variables-list');
      let html = '';
      
      allVariableAssigned.forEach((variableGroup, groupIndex) => {
        const isShadsyncVariable = variableGroup.currentVariable.collection === 'shadsync theme';
        const isReplaced = variableGroup.replaced === true;
        const borderColor = isReplaced ? '#4caf50' : (isShadsyncVariable ? '#4caf50' : '#ff6b35');
        const backgroundColor = isReplaced ? '#f1f8e9' : '#f8f9fa';
        const badgeColor = isReplaced ? '#4caf50' : (isShadsyncVariable ? '#4caf50' : '#ff6b35');
        const textColor = isReplaced ? '#2e7d32' : '#333';
        
        // Use the cleaner suggestion-item layout
        html += `
          <div class="suggestion-item" style="border-left: 4px solid ${borderColor}; background: ${backgroundColor};">
            <div class="suggestion-header">
              <div class="object-info" style="color: ${textColor}; display: flex; justify-content: space-between; align-items: center;">
                <strong>${variableGroup.currentVariable.name}</strong>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 12px; font-size: 10px;">
                    ${variableGroup.objects.length} object${variableGroup.objects.length !== 1 ? 's' : ''}
                  </span>
                  ${isReplaced ? '<span style="color: #4caf50; font-size: 12px;">‚úÖ Replaced</span>' : ''}
                  ${isShadsyncVariable && !isReplaced ? '<span style="color: #4caf50; font-size: 12px;">‚úÖ Already ShadSync</span>' : ''}
                </div>
              </div>
            </div>
            
            <div class="suggestion-row">
              <select class="select-dropdown" id="select-all-group-${groupIndex}" onchange="updateAllVariableSelectedVariable('${variableGroup.currentVariable.name}', this.value, ${groupIndex})" ${isReplaced ? 'disabled' : ''}>
                <option value="">${isShadsyncVariable ? 'Switch to different shadsync variable...' : 'Choose shadsync replacement...'}</option>
        `;
        
        // Add all shadsync variables to dropdown
        if (variableGroup.allShadSyncVariables && variableGroup.allShadSyncVariables.length > 0) {
          // First show smart suggestions if any
          if (variableGroup.allSuggestions && variableGroup.allSuggestions.length > 0) {
            html += '<optgroup label="‚≠ê Smart Suggestions">';
            variableGroup.allSuggestions.forEach(suggestion => {
              const selected = variableGroup.suggestion && suggestion.id === variableGroup.suggestion.id ? 'selected' : '';
              const emoji = suggestion.score >= 80 ? '‚≠ê' : suggestion.score >= 60 ? '‚úÖ' : 'üîß';
              html += `<option value="${suggestion.id}" ${selected}>${emoji} ${suggestion.name} (${suggestion.score}% match)</option>`;
            });
            html += '</optgroup>';
          }
          
          // Then show all available variables
          html += '<optgroup label="üé® All ShadSync Variables">';
          variableGroup.allShadSyncVariables.forEach(variable => {
            const isCurrentVariable = variable.id === variableGroup.currentVariable.id;
            const isInSuggestions = variableGroup.allSuggestions && 
              variableGroup.allSuggestions.some(s => s.id === variable.id);
            if (!isInSuggestions && !isCurrentVariable) {
              html += `<option value="${variable.id}">${variable.name}</option>`;
            } else if (isCurrentVariable) {
              html += `<option value="${variable.id}" style="color: #666; font-style: italic;">${variable.name} (current)</option>`;
            }
          });
          html += '</optgroup>';
        }
        
        html += `
              </select>
              <button class="replace-btn" id="replace-all-btn-${groupIndex}" data-group-index="${groupIndex}" data-select-id="select-all-group-${groupIndex}"
                      style="background: ${borderColor};" ${isReplaced ? 'disabled' : ''}>
                ${isReplaced ? '‚úÖ Replaced' : 'Replace'}
              </button>
            </div>
          </div>
        `;
      });
      
      listDiv.innerHTML = html;
      
      // Store the grouped data for replacement functionality
      window.allVariableGroups = allVariableAssigned;
      
      // Add event listeners to replace buttons
      setTimeout(() => {
        allVariableAssigned.forEach((variableGroup, index) => {
          const button = document.getElementById(`replace-all-btn-${index}`);
          if (button) {
            console.log(`Adding event listener to all-variables button ${index}`);
            button.addEventListener('click', function() {
              console.log(`All-variables button ${index} clicked`);
              const buttonGroupIndex = parseInt(this.getAttribute('data-group-index'));
              const selectId = this.getAttribute('data-select-id');
              window.applyAllVariableGroupReplacement(buttonGroupIndex, selectId);
            });
          } else {
            console.error(`All-variables button not found: replace-all-btn-${index}`);
          }
        });
      }, 100);
    }

    // Display objects without variables
    function displayUnassignedObjects(unassignedObjects) {
      const listDiv = document.getElementById('unassigned-list');
      let html = '';
      
      unassignedObjects.forEach((item, index) => {
        const hasColor = item.color && (item.color.r !== undefined || item.color.g !== undefined || item.color.b !== undefined);
        const colorStyle = hasColor ? 
          `background: rgb(${Math.round((item.color.r || 0) * 255)}, ${Math.round((item.color.g || 0) * 255)}, ${Math.round((item.color.b || 0) * 255)})` : 
          'background: #ccc';
        
        html += `
          <div class="suggestion-item">
            <div class="suggestion-header">
              <div class="object-info">${item.node.name} (${item.node.type})</div>
            </div>
            <div class="current-variable">No variable assigned</div>
        `;
        
        if (item.allSuggestions && item.allSuggestions.length > 0) {
          html += `
            <div class="suggestion-row">
              <div class="color-preview" style="${colorStyle}"></div>
              <select class="select-dropdown" id="select-${index}-unassigned" onchange="updateSelectedVariable('${item.node.id}', '${item.property}', this.value, ${item.fillIndex || 0}, ${item.strokeIndex || 0})">
                <option value="">Choose shadsync variable...</option>
          `;
          
          item.allSuggestions.forEach(suggestion => {
            const selected = item.suggestion && suggestion.id === item.suggestion.id ? 'selected' : '';
            html += `<option value="${suggestion.id}" ${selected}>${suggestion.name} (${suggestion.score}% match)</option>`;
          });
          
          html += `
              </select>
              <button class="replace-btn" onclick="applySelectedVariable('${item.node.id}', '${item.property}', 'select-${index}-unassigned', ${item.fillIndex || 0}, ${item.strokeIndex || 0})">
                Apply
              </button>
            </div>
          `;
        } else {
          html += `
            <div class="no-suggestion">No matching shadsync variable found</div>
          `;
        }
        
        html += '</div>';
      });
      
      listDiv.innerHTML = html;
    }
    
    // Display usage summary
    function displayUsageSummary(variablesByCollection, mainCollectionName) {
      const listDiv = document.getElementById('variables-list');
      let html = '';
      
      Object.entries(variablesByCollection).forEach(([collectionName, variables]) => {
        const isMainCollection = collectionName === mainCollectionName;
        html += `
          <div class="collection-group">
            <div class="collection-title">
              ${collectionName} ${isMainCollection ? '(Main)' : ''}
              <span style="color: #666; font-weight: normal;">(${variables.length} variables)</span>
            </div>
            <div class="variables-list">
        `;
        
        variables.forEach(variable => {
          html += `
            <div class="variable-item">
              ${variable.name} <span style="color: #666;">(${variable.type})</span>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      listDiv.innerHTML = html;
    }
    
    // Replace variable function
    function replaceVariable(nodeId, property, newVariableId) {
      parent.postMessage({
        pluginMessage: {
          type: 'replace-variable',
          nodeId: nodeId,
          property: property,
          newVariableId: newVariableId
        }
      }, '*');
    }
    
    // Update selected variable in dropdown
    function updateSelectedVariable(nodeId, property, newVariableId, fillIndex, strokeIndex) {
      // This function can be used to provide immediate feedback
      console.log('Variable selected:', newVariableId);
    }
    
    // Update selected variable for all-variable groups (called by dropdown onchange)
    function updateAllVariableSelectedVariable(originalVariableName, newVariableId, groupIndex) {
      console.log('updateAllVariableSelectedVariable called:', originalVariableName, newVariableId, groupIndex);
      
      // Store the selection for when Apply is clicked
      if (window.allVariableGroups && window.allVariableGroups[groupIndex]) {
        window.allVariableGroups[groupIndex].selectedVariableId = newVariableId;
      }
      
      // Visual feedback: enable/disable Apply button based on selection
      const button = document.getElementById(`replace-all-btn-${groupIndex}`);
      if (button && !button.disabled) {
        if (newVariableId) {
          button.style.opacity = '1';
          button.style.cursor = 'pointer';
        } else {
          button.style.opacity = '0.6';
          button.style.cursor = 'not-allowed';
        }
      }
    }
    
    // Apply selected variable from dropdown
    function applySelectedVariable(nodeId, property, selectId, fillIndex, strokeIndex) {
      const selectElement = document.getElementById(selectId);
      const newVariableId = selectElement.value;
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      // Find the button that was clicked (should be near the select)
      const container = selectElement.closest('.suggestion-item');
      const button = container ? container.querySelector('.replace-btn') : null;
      
      // Visual feedback: mark as applied
      if (button) {
        button.style.background = '#4caf50';
        button.textContent = '‚úÖ Applied';
        button.disabled = true;
      }
      
      // Update the card visual appearance
      if (container) {
        container.style.borderLeftColor = '#4caf50';
        container.style.background = '#f1f8e9';
        
        // Update text colors
        const objectInfo = container.querySelector('.object-info');
        const currentVariable = container.querySelector('.current-variable');
        if (objectInfo) objectInfo.style.color = '#2e7d32';
        if (currentVariable) currentVariable.style.color = '#2e7d32';
        
        // Add success checkmark to header
        if (objectInfo && !objectInfo.querySelector('.success-indicator')) {
          const successSpan = document.createElement('span');
          successSpan.className = 'success-indicator';
          successSpan.style.cssText = 'color: #4caf50; font-size: 12px; margin-left: 8px;';
          successSpan.textContent = '‚úÖ Applied';
          objectInfo.appendChild(successSpan);
        }
      }
      
      // Disable the dropdown
      selectElement.disabled = true;
      
      parent.postMessage({
        pluginMessage: {
          type: 'replace-variable',
          nodeId: nodeId,
          property: property,
          newVariableId: newVariableId,
          fillIndex: fillIndex,
          strokeIndex: strokeIndex
        }
      }, '*');
      
      showStatus('‚úÖ Variable replacement applied successfully!', 'success');
    }

    // Make sure the function is available globally
    window.applyGroupReplacement = function(groupIndex, selectId) {
      console.log('applyGroupReplacement called:', groupIndex, selectId);
      console.log('Available functions:', typeof updateSelectedVariable, typeof applySelectedVariable);
      console.log('Window object keys:', Object.keys(window));
      
      const selectElement = document.getElementById(selectId);
      if (!selectElement) {
        console.error('Select element not found:', selectId);
        console.log('Available elements with select-group prefix:', document.querySelectorAll('[id^="select-group"]'));
        showStatus('Dropdown not found', 'error');
        return;
      }
      
      const newVariableId = selectElement.value;
      console.log('Selected variable ID:', newVariableId);
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      if (!window.nonShadSyncGroups || !window.nonShadSyncGroups[groupIndex]) {
        console.error('Group data not found:', window.nonShadSyncGroups, groupIndex);
        showStatus('Group data not found', 'error');
        return;
      }
      
      const group = window.nonShadSyncGroups[groupIndex];
      console.log('Processing group:', group);
      let replacementCount = 0;
      
      // Replace variable for each object in the group
      group.objects.forEach((obj, index) => {
        console.log(`Replacing object ${index + 1}:`, obj.node.id, obj.property, newVariableId);
        
        parent.postMessage({
          pluginMessage: {
            type: 'replace-variable',
            nodeId: obj.node.id,
            property: obj.property,
            newVariableId: newVariableId,
            fillIndex: obj.fillIndex || 0,
            strokeIndex: obj.strokeIndex || 0
          }
        }, '*');
        replacementCount++;
      });
      
      showStatus(`Replacing variable for ${replacementCount} objects...`, 'info');
      
      // Re-run detection after a short delay to update the UI
      setTimeout(() => {
        console.log('Re-running variable check...');
        parent.postMessage({
          pluginMessage: { type: 'check-variables' }
        }, '*');
      }, 1000);
    };

    // Replace all non-shadsync variables with their best suggestions
    window.replaceAllNonShadSync = function() {
      console.log('replaceAllNonShadSync called');
      
      if (!window.nonShadSyncGroups || window.nonShadSyncGroups.length === 0) {
        showStatus('No non-shadsync variables found', 'error');
        return;
      }
      
      let totalReplacements = 0;
      let groupsWithSuggestions = 0;
      
      // Process each group
      window.nonShadSyncGroups.forEach((group, groupIndex) => {
        if (group.suggestion && group.suggestion.id) {
          groupsWithSuggestions++;
          
          // Replace variable for each object in the group
          group.objects.forEach((obj, objIndex) => {
            console.log(`Replacing object ${objIndex + 1} in group ${groupIndex}:`, obj.node.id, obj.property, group.suggestion.id);
            
            parent.postMessage({
              pluginMessage: {
                type: 'replace-variable',
                nodeId: obj.node.id,
                property: obj.property,
                newVariableId: group.suggestion.id,
                fillIndex: obj.fillIndex || 0,
                strokeIndex: obj.strokeIndex || 0
              }
            }, '*');
            totalReplacements++;
          });
        } else {
          console.warn(`Group ${groupIndex} has no suggestion:`, group);
        }
      });
      
      if (totalReplacements > 0) {
        showStatus(`Replacing ${totalReplacements} objects across ${groupsWithSuggestions} variable groups...`, 'info');
        
        // Re-run detection after a delay to update the UI
        setTimeout(() => {
          console.log('Re-running variable check after bulk replacement...');
          parent.postMessage({
            pluginMessage: { type: 'check-variables' }
          }, '*');
        }, 1500); // Slightly longer delay for bulk operation
      } else {
        showStatus('No suitable suggestions found for bulk replacement', 'warning');
      }
    };

    // Replace all variables (both non-shadsync and all-variables with suggestions)
    window.replaceAllVariables = function() {
      console.log('replaceAllVariables called');
      
      let totalReplacements = 0;
      let groupsWithSuggestions = 0;
      
      // Process non-shadsync variables
      if (window.nonShadSyncGroups && window.nonShadSyncGroups.length > 0) {
        window.nonShadSyncGroups.forEach((group, groupIndex) => {
          if (group.suggestion && group.suggestion.id) {
            groupsWithSuggestions++;
            
            // Replace variable for each object in the group
            group.objects.forEach((obj, objIndex) => {
              console.log(`Replacing non-shadsync object ${objIndex + 1} in group ${groupIndex}:`, obj.node.id, obj.property, group.suggestion.id);
              
              parent.postMessage({
                pluginMessage: {
                  type: 'replace-variable',
                  nodeId: obj.node.id,
                  property: obj.property,
                  newVariableId: group.suggestion.id,
                  fillIndex: obj.fillIndex || 0,
                  strokeIndex: obj.strokeIndex || 0
                }
              }, '*');
              totalReplacements++;
            });
          }
        });
      }
      
      // Process all-variable-assigned objects
      if (window.allVariableGroups && window.allVariableGroups.length > 0) {
        window.allVariableGroups.forEach((group, groupIndex) => {
          if (group.suggestion && group.suggestion.id) {
            groupsWithSuggestions++;
            
            // Replace variable for each object in the group
            group.objects.forEach((obj, objIndex) => {
              console.log(`Replacing all-variable object ${objIndex + 1} in group ${groupIndex}:`, obj.node.id, obj.property, group.suggestion.id);
              
              parent.postMessage({
                pluginMessage: {
                  type: 'replace-variable',
                  nodeId: obj.node.id,
                  property: obj.property,
                  newVariableId: group.suggestion.id,
                  fillIndex: obj.fillIndex || 0,
                  strokeIndex: obj.strokeIndex || 0
                }
              }, '*');
              totalReplacements++;
            });
          }
        });
      }
      
      if (totalReplacements > 0) {
        showStatus(`Replacing ${totalReplacements} objects across ${groupsWithSuggestions} variable groups...`, 'info');
        
        // Re-run detection after a delay to update the UI
        setTimeout(() => {
          console.log('Re-running variable check after bulk replacement...');
          parent.postMessage({
            pluginMessage: { type: 'check-variables' }
          }, '*');
        }, 1500); // Slightly longer delay for bulk operation
      } else {
        showStatus('No suitable suggestions found for bulk replacement', 'warning');
      }
    };

    // Apply group replacement for all variable-assigned objects
    window.applyAllVariableGroupReplacement = function(groupIndex, selectId) {
      console.log('applyAllVariableGroupReplacement called:', groupIndex, selectId);
      
      const selectElement = document.getElementById(selectId);
      if (!selectElement) {
        console.error('Select element not found:', selectId);
        showStatus('Dropdown not found', 'error');
        return;
      }
      
      const newVariableId = selectElement.value;
      console.log('Selected variable ID:', newVariableId);
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      if (!window.allVariableGroups || !window.allVariableGroups[groupIndex]) {
        console.error('All-variable group data not found:', window.allVariableGroups, groupIndex);
        showStatus('Group data not found', 'error');
        return;
      }
      
      const group = window.allVariableGroups[groupIndex];
      console.log('Processing all-variable group:', group);
      let replacementCount = 0;
      
      // Visual feedback: mark as applying
      const button = document.getElementById(`replace-all-btn-${groupIndex}`);
      if (button) {
        button.style.background = '#4caf50';
        button.textContent = '‚úÖ Replaced';
        button.disabled = true;
      }
      
      // Mark the group as replaced
      if (window.allVariableGroups[groupIndex]) {
        window.allVariableGroups[groupIndex].replaced = true;
      }
      
      // Update the card visual appearance
      const card = button.closest('.suggestion-item');
      if (card) {
        card.style.borderLeftColor = '#4caf50';
        card.style.background = '#f1f8e9';
        
        // Update text colors
        const objectInfo = card.querySelector('.object-info');
        const currentVariable = card.querySelector('.current-variable');
        if (objectInfo) objectInfo.style.color = '#2e7d32';
        if (currentVariable) currentVariable.style.color = '#2e7d32';
        
        // Add success checkmark to header
        if (objectInfo && !objectInfo.querySelector('.success-indicator')) {
          const successSpan = document.createElement('span');
          successSpan.className = 'success-indicator';
          successSpan.style.cssText = 'color: #4caf50; font-size: 12px; margin-left: 8px;';
          successSpan.textContent = '‚úÖ Replaced';
          objectInfo.appendChild(successSpan);
        }
      }
      
      // Disable the dropdown
      selectElement.disabled = true;
      
      // Replace variable for each object in the group
      group.objects.forEach((obj, index) => {
        console.log(`Replacing all-variable object ${index + 1}:`, obj.node.id, obj.property, newVariableId);
        
        parent.postMessage({
          pluginMessage: {
            type: 'replace-variable',
            nodeId: obj.node.id,
            property: obj.property,
            newVariableId: newVariableId,
            fillIndex: obj.fillIndex || 0,
            strokeIndex: obj.strokeIndex || 0
          }
        }, '*');
        replacementCount++;
      });
      
      showStatus(`‚úÖ Successfully replaced variable for ${replacementCount} objects!`, 'success');
      
      // Re-run detection after a short delay to update the UI
      setTimeout(() => {
        console.log('Re-running variable check after all-variable replacement...');
        parent.postMessage({
          pluginMessage: { type: 'check-variables' }
        }, '*');
      }, 1000);
    };

    // Apply group replacement for all variable-assigned objects
    function applyAllVariableGroupReplacement(groupIndex, selectId) {
      return window.applyAllVariableGroupReplacement(groupIndex, selectId);
    }

    // Apply group replacement - replace variable for all objects in a group
    function applyGroupReplacement(groupIndex, selectId) {
      return window.applyGroupReplacement(groupIndex, selectId);
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
      console.log('Page loaded. Available functions:');
      console.log('- applyGroupReplacement:', typeof applyGroupReplacement);
      console.log('- applySelectedVariable:', typeof applySelectedVariable);
      console.log('- updateSelectedVariable:', typeof updateSelectedVariable);
    });
  </script>
    </div>
  </div>
</body>
</html>
