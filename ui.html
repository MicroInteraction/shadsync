<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ShadSync</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
      background: #ffffff;
      color: #333333;
      padding: 16px;
      height: 100vh;
      overflow-y: auto;
    }

    .header {
      margin-bottom: 24px;
    }

    .logo {
      font-size: 18px;
      font-weight: 600;
      color: #ff6b35;
      margin-bottom: 16px;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tab {
      padding: 8px 16px;
      border: none;
      background: #f5f5f5;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .tab.active {
      background: #333333;
      color: white;
    }

    .tab:hover {
      background: #e0e0e0;
    }

    .tab.active:hover {
      background: #333333;
    }

    .section {
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: #333333;
    }

    .input-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 500;
      color: #666666;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      font-size: 12px;
      line-height: 1.5;
      resize: vertical;
      background: #fafafa;
    }

    textarea::placeholder {
      color: #999999;
    }

    textarea:focus {
      outline: none;
      border-color: #ff6b35;
      box-shadow: 0 0 0 2px rgba(255, 107, 53, 0.1);
    }

    select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: white;
      font-size: 14px;
    }

    select:focus {
      outline: none;
      border-color: #ff6b35;
    }

    .button {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }

    .button-primary {
      background: #ff6b35;
      color: white;
    }

    .button-primary:hover {
      background: #ff5722;
    }

    .button-secondary {
      background: #f5f5f5;
      color: #333333;
      border: 1px solid #e0e0e0;
    }

    .button-secondary:hover {
      background: #eeeeee;
    }

    .status {
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 16px;
      font-size: 12px;
      line-height: 1.4;
      display: none;
    }

    .status.success {
      background: #e8f5e8;
      color: #2d5a2d;
      border: 1px solid #c3e6c3;
    }

    .status.error {
      background: #ffeaea;
      color: #d32f2f;
      border: 1px solid #ffcdd2;
    }

    .status.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .variables-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      background: #fafafa;
    }

    .variable-item {
      padding: 8px 12px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .variable-item:last-child {
      border-bottom: none;
    }

    .collection-group {
      margin-bottom: 16px;
    }

    .collection-title {
      font-weight: 600;
      color: #333333;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .hidden {
      display: none !important;
    }

    .tab-content {
      display: block;
    }

    .tab-content.hidden {
      display: none !important;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .checkbox-group input[type="checkbox"] {
      margin: 0;
    }

    .checkbox-group label {
      margin: 0;
      font-size: 14px;
      text-transform: none;
      letter-spacing: normal;
      color: #333333;
    }

    .suggestion-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .object-info {
      font-size: 12px;
      color: #666;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .current-variable {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .suggestion-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .color-preview {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }

    .variable-name {
      flex: 1;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      color: #333;
    }

    .replace-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .replace-btn:hover {
      background: #ff5722;
    }

    .replace-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .no-suggestion {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }

    .suggestion-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .dropdown-suggestions {
      margin-top: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .dropdown-suggestions.show {
      display: block;
    }

    .dropdown-item {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .suggestion-score {
      font-size: 10px;
      color: #999;
      margin-left: auto;
    }

    .current-selection {
      background: #e3f2fd !important;
      color: #1976d2;
    }

    .select-dropdown {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .variable-group {
      background: #ffffff;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .variable-group-header {
      background: #fff3f0;
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
    }

    .affected-objects {
      background: #fafafa;
      padding: 12px;
    }

    .object-item {
      display: flex;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .object-item:last-child {
      border-bottom: none;
    }

    .group-replacement {
      margin-top: 12px;
    }

    .suggestion-item {
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .suggestion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .object-info {
      font-size: 12px;
      color: #666;
      font-family: 'SF Mono', Monaco, monospace;
    }

    .current-variable {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
    }

    .suggestion-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      background: white;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
    }

    .color-preview {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      border: 1px solid #ccc;
      flex-shrink: 0;
    }

    .variable-name {
      flex: 1;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      color: #333;
    }

    .replace-btn {
      padding: 4px 8px;
      font-size: 11px;
      background: #ff6b35;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .replace-btn:hover {
      background: #ff5722;
    }

    .replace-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .no-suggestion {
      color: #999;
      font-style: italic;
      font-size: 12px;
    }

    .suggestion-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .dropdown-suggestions {
      margin-top: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      display: none;
    }

    .dropdown-suggestions.show {
      display: block;
    }

    .dropdown-item {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 6px;
      border-bottom: 1px solid #f0f0f0;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: #f5f5f5;
    }

    .suggestion-score {
      font-size: 10px;
      color: #999;
      margin-left: auto;
    }

    .current-selection {
      background: #e3f2fd !important;
      color: #1976d2;
    }

    .select-dropdown {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      background: white;
      font-size: 12px;
      font-family: 'SF Mono', Monaco, monospace;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">shadsync</div>
    <div class="tabs">
      <button class="tab active" data-tab="update">Update Theme</button>
      <button class="tab" data-tab="detect">Detect</button>
    </div>
  </div>

  <!-- Update Theme Tab -->
  <div id="update-tab" class="tab-content">
    <div class="section">
      <label for="css-input">Paste CSS</label>
      <textarea 
        id="css-input" 
        placeholder=":root {
  --background: #f9f9fa;
  --foreground: #333333;
  --card: #ffffff;
  --card-foreground: #333333;
  --popover: #ffffff;
  --primary: 220 80% 60%;
  --primary-foreground: #ffffff;
}"
      ></textarea>
    </div>

    <div class="input-group">
      <label>Collection</label>
      <div style="padding: 8px 12px; background: #f5f5f5; border-radius: 6px; color: #666; font-size: 14px;">
        shadsync theme
      </div>
    </div>

    <div class="status" id="status"></div>

    <button class="button button-primary" id="update-variables">
      Update Variables
    </button>
  </div>

  <!-- Detect Tab -->
  <div id="detect-tab" class="tab-content hidden">
    <div class="section">
      <div class="section-title">Find & Replace Variables</div>
      <p style="font-size: 12px; color: #666; margin-bottom: 16px;">
        Detects objects using variables from other collections and suggests shadsync theme replacements.
      </p>
      <button class="button button-secondary" id="check-variables">
        Scan for Non-ShadSync Variables
      </button>
      
      <div id="variables-result" class="hidden">
        <!-- Non-ShadSync Variables Section -->
        <div id="non-shadsync-section" class="hidden">
          <div class="section-title" style="color: #ff6b35;">⚠️ Variables from Other Collections</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            These variables from other collections are being used. Replace them with shadsync theme variables:
          </p>
          <div class="suggestion-list" id="non-shadsync-list"></div>
        </div>
        
        <!-- All Variable-Assigned Objects Section -->
        <div id="all-variables-section" class="hidden">
          <div class="section-title" style="color: #2196f3;">🔄 All Variable-Assigned Objects</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            All objects using variables (from any collection). Review and replace with better shadsync theme options:
          </p>
          <div class="suggestion-list" id="all-variables-list"></div>
        </div>
        
        <!-- Unassigned Objects Section -->
        <div id="unassigned-section" class="hidden">
          <div class="section-title" style="color: #999;">Objects Without Variables</div>
          <p style="font-size: 11px; color: #666; margin-bottom: 12px;">
            These objects have colors but no variables assigned:
          </p>
          <div class="suggestion-list" id="unassigned-list"></div>
        </div>
        
        <!-- Current Usage Summary -->
        <div id="usage-summary" class="hidden">
          <div class="section-title" style="color: #4caf50;">✅ Current ShadSync Usage</div>
          <div id="variables-list"></div>
        </div>
        
        <!-- All Clear Message -->
        <div id="all-clear-message" class="hidden">
          <div style="text-align: center; padding: 24px; color: #4caf50;">
            <div style="font-size: 18px; margin-bottom: 8px;">🎉</div>
            <div style="font-weight: 600; margin-bottom: 4px;">All Good!</div>
            <div style="font-size: 12px; color: #666;">All objects are using shadsync theme variables or have no variables assigned.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        
        // Show selected tab content
        const targetTab = document.getElementById(`${tabName}-tab`);
        if (targetTab) {
          targetTab.classList.remove('hidden');
        }
        
        // Clear status when switching tabs
        hideStatus();
      });
    });

    // Status message functions
    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      if (type === 'success') {
        setTimeout(() => {
          status.style.display = 'none';
        }, 5000);
      }
    }

    function hideStatus() {
      document.getElementById('status').style.display = 'none';
    }

    // Update Variables
    document.getElementById('update-variables').addEventListener('click', () => {
      const css = document.getElementById('css-input').value.trim();
      
      if (!css) {
        showStatus('Please paste CSS variables first', 'error');
        return;
      }
      
      showStatus('Processing variables...', 'info');
      document.body.classList.add('loading');
      
      parent.postMessage({
        pluginMessage: {
          type: 'convert-css',
          css: css,
          collectionName: 'shadsync theme'
        }
      }, '*');
    });

    // Check Variables
    document.getElementById('check-variables').addEventListener('click', () => {
      showStatus('Scanning document for variables...', 'info');
      document.body.classList.add('loading');
      
      parent.postMessage({
        pluginMessage: {
          type: 'check-variables'
        }
      }, '*');
    });

    // Handle messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;
      
      document.body.classList.remove('loading');
      
      switch (msg.type) {
        case 'success':
          showStatus(msg.message, 'success');
          break;
          
        case 'error':
          showStatus(msg.message, 'error');
          break;
          
        case 'status':
          showStatus(msg.message, 'info');
          break;
          
        case 'variables-check-result':
          displayVariablesResult(msg.data);
          // Show scan summary
          const summary = msg.data.scanSummary;
          if (summary.nonShadSyncCount > 0) {
            showStatus(`Found ${summary.nonShadSyncCount} non-shadsync variable${summary.nonShadSyncCount !== 1 ? 's' : ''} in use`, 'error');
          } else if (summary.allVariableCount > 0) {
            showStatus(`Found ${summary.allVariableCount} variable${summary.allVariableCount !== 1 ? 's' : ''} in use (review for optimization)`, 'info');
          } else if (summary.unassignedCount > 0) {
            showStatus(`Found ${summary.unassignedCount} objects without variables assigned`, 'info');
          } else {
            showStatus('All objects are using shadsync theme variables! 🎉', 'success');
          }
          break;
      }
    };

    // Display variables check result
    function displayVariablesResult(data) {
      const resultDiv = document.getElementById('variables-result');
      
      // Show/hide sections based on data
      const nonShadSyncSection = document.getElementById('non-shadsync-section');
      const allVariablesSection = document.getElementById('all-variables-section');
      const unassignedSection = document.getElementById('unassigned-section');
      const usageSummarySection = document.getElementById('usage-summary');
      const allClearMessage = document.getElementById('all-clear-message');
      
      // Priority 1: Non-ShadSync Variables (most important)
      if (data.nonShadSyncVariables && data.nonShadSyncVariables.length > 0) {
        displayNonShadSyncVariables(data.nonShadSyncVariables);
        nonShadSyncSection.classList.remove('hidden');
      } else {
        nonShadSyncSection.classList.add('hidden');
      }
      
      // Priority 2: All Variable-Assigned Objects (for review and optimization)
      if (data.allVariableAssigned && data.allVariableAssigned.length > 0) {
        displayAllVariableAssigned(data.allVariableAssigned);
        allVariablesSection.classList.remove('hidden');
      } else {
        allVariablesSection.classList.add('hidden');
      }
      
      // Priority 3: Unassigned Objects (secondary)
      if (data.unassignedObjects && data.unassignedObjects.length > 0) {
        displayUnassignedObjects(data.unassignedObjects);
        unassignedSection.classList.remove('hidden');
      } else {
        unassignedSection.classList.add('hidden');
      }
      
      // Usage Summary (always show if we have shadsync variables being used)
      if (data.variablesByCollection && data.variablesByCollection['shadsync theme']) {
        displayUsageSummary(data.variablesByCollection, data.mainCollectionName);
        usageSummarySection.classList.remove('hidden');
      } else {
        usageSummarySection.classList.add('hidden');
      }
      
      // Show "All Clear" message if no issues found
      if ((!data.nonShadSyncVariables || data.nonShadSyncVariables.length === 0) && 
          (!data.unassignedObjects || data.unassignedObjects.length === 0)) {
        allClearMessage.classList.remove('hidden');
      } else {
        allClearMessage.classList.add('hidden');
      }
      
      resultDiv.classList.remove('hidden');
      hideStatus();
    }
    
    // Display variables from non-shadsync collections (grouped by variable)
    function displayNonShadSyncVariables(nonShadSyncVariables) {
      const listDiv = document.getElementById('non-shadsync-list');
      let html = '';
      
      nonShadSyncVariables.forEach((variableGroup, groupIndex) => {
        // Variable group header
        html += `
          <div class="variable-group" style="border-left: 3px solid #ff6b35; margin-bottom: 16px; background: #fff;">
            <div class="variable-group-header" style="background: #fff3f0; padding: 12px; border-radius: 6px 6px 0 0;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                <div>
                  <span style="color: #ff6b35; font-weight: 600;">Variable:</span> 
                  <strong>${variableGroup.currentVariable.name}</strong> 
                  <span style="color: #666;">from "${variableGroup.currentVariable.collection}"</span>
                </div>
                <span style="background: #ff6b35; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                  ${variableGroup.objects.length} object${variableGroup.objects.length !== 1 ? 's' : ''}
                </span>
              </div>
              
              <!-- Replacement dropdown for the entire group -->
              <div class="group-replacement" style="margin-top: 12px;">
                <select class="select-dropdown" id="select-group-${groupIndex}" style="width: 100%; margin-bottom: 8px;">
                  <option value="">🔄 Choose shadsync replacement for all objects...</option>
        `;
        
        // Add all shadsync variables to dropdown
        if (variableGroup.allShadSyncVariables && variableGroup.allShadSyncVariables.length > 0) {
          // First show smart suggestions if any
          if (variableGroup.allSuggestions && variableGroup.allSuggestions.length > 0) {
            html += '<optgroup label="📍 Smart Suggestions">';
            variableGroup.allSuggestions.forEach(suggestion => {
              const selected = variableGroup.suggestion && suggestion.id === variableGroup.suggestion.id ? 'selected' : '';
              const emoji = suggestion.score >= 80 ? '⭐' : suggestion.score >= 60 ? '✅' : '🔧';
              html += `<option value="${suggestion.id}" ${selected}>${emoji} ${suggestion.name} (${suggestion.score}% match)</option>`;
            });
            html += '</optgroup>';
          }
          
          // Then show all available variables
          html += '<optgroup label="🎨 All ShadSync Variables">';
          variableGroup.allShadSyncVariables.forEach(variable => {
            const isInSuggestions = variableGroup.allSuggestions && 
              variableGroup.allSuggestions.some(s => s.id === variable.id);
            if (!isInSuggestions) {
              html += `<option value="${variable.id}">${variable.name}</option>`;
            }
          });
          html += '</optgroup>';
        }
        
        html += `
                </select>
                <button class="replace-btn" id="replace-btn-${groupIndex}" data-group-index="${groupIndex}" data-select-id="select-group-${groupIndex}"
                        style="background: #ff6b35; width: 100%;">
                  Replace All ${variableGroup.objects.length} Objects
                </button>
              </div>
            </div>
            
            <!-- List of affected objects -->
            <div class="affected-objects" style="padding: 12px; background: #fafafa;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #666;">Affected Objects:</div>
        `;
        
        // Show each affected object
        variableGroup.objects.forEach((obj, objIndex) => {
          const hasColor = obj.color && (obj.color.r !== undefined || obj.color.g !== undefined || obj.color.b !== undefined);
          const colorStyle = hasColor ? 
            `background: rgb(${Math.round((obj.color.r || 0) * 255)}, ${Math.round((obj.color.g || 0) * 255)}, ${Math.round((obj.color.b || 0) * 255)})` : 
            'background: #ccc';
          
          html += `
            <div class="object-item" style="display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee;">
              <div class="color-preview" style="${colorStyle}; width: 16px; height: 16px; border-radius: 3px; margin-right: 8px; border: 1px solid #ddd;"></div>
              <span style="flex: 1;">${obj.node.name} (${obj.node.type})</span>
              <span style="font-size: 12px; color: #666; text-transform: capitalize;">${obj.property}</span>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      listDiv.innerHTML = html;
      
      // Store the grouped data for replacement functionality
      window.nonShadSyncGroups = nonShadSyncVariables;
      
      // Add event listeners to replace buttons
      setTimeout(() => {
        nonShadSyncVariables.forEach((variableGroup, index) => {
          const button = document.getElementById(`replace-btn-${index}`);
          if (button) {
            console.log(`Adding event listener to button ${index}`);
            button.addEventListener('click', function() {
              console.log(`Button ${index} clicked`);
              const buttonGroupIndex = parseInt(this.getAttribute('data-group-index'));
              const selectId = this.getAttribute('data-select-id');
              window.applyGroupReplacement(buttonGroupIndex, selectId);
            });
          } else {
            console.error(`Button not found: replace-btn-${index}`);
          }
        });
      }, 100);
    }
    
    // Display all variable-assigned objects for review and replacement
    function displayAllVariableAssigned(allVariableAssigned) {
      const listDiv = document.getElementById('all-variables-list');
      let html = '';
      
      allVariableAssigned.forEach((variableGroup, groupIndex) => {
        const isShadsyncVariable = variableGroup.currentVariable.collection === 'shadsync theme';
        const borderColor = isShadsyncVariable ? '#4caf50' : '#2196f3';
        const badgeColor = isShadsyncVariable ? '#4caf50' : '#2196f3';
        
        // Variable group header
        html += `
          <div class="variable-group" style="border-left: 3px solid ${borderColor}; margin-bottom: 16px; background: #fff;">
            <div class="variable-group-header" style="background: ${isShadsyncVariable ? '#f1f8e9' : '#e3f2fd'}; padding: 12px; border-radius: 6px 6px 0 0;">
              <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px;">
                <div>
                  <span style="color: ${borderColor}; font-weight: 600;">Variable:</span> 
                  <strong>${variableGroup.currentVariable.name}</strong> 
                  <span style="color: #666;">from "${variableGroup.currentVariable.collection}"</span>
                  ${isShadsyncVariable ? '<span style="color: #4caf50; font-size: 12px;">✅ Already ShadSync</span>' : ''}
                </div>
                <span style="background: ${badgeColor}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px;">
                  ${variableGroup.objects.length} object${variableGroup.objects.length !== 1 ? 's' : ''}
                </span>
              </div>
              
              <!-- Replacement dropdown for the entire group -->
              <div class="group-replacement" style="margin-top: 12px;">
                <select class="select-dropdown" id="select-all-group-${groupIndex}" style="width: 100%; margin-bottom: 8px;">
                  <option value="">🔄 ${isShadsyncVariable ? 'Switch to different shadsync variable...' : 'Choose shadsync replacement for all objects...'}</option>
        `;
        
        // Add all shadsync variables to dropdown
        if (variableGroup.allShadSyncVariables && variableGroup.allShadSyncVariables.length > 0) {
          // First show smart suggestions if any
          if (variableGroup.allSuggestions && variableGroup.allSuggestions.length > 0) {
            html += '<optgroup label="📍 Smart Suggestions">';
            variableGroup.allSuggestions.forEach(suggestion => {
              const selected = variableGroup.suggestion && suggestion.id === variableGroup.suggestion.id ? 'selected' : '';
              const emoji = suggestion.score >= 80 ? '⭐' : suggestion.score >= 60 ? '✅' : '🔧';
              html += `<option value="${suggestion.id}" ${selected}>${emoji} ${suggestion.name} (${suggestion.score}% match)</option>`;
            });
            html += '</optgroup>';
          }
          
          // Then show all available variables
          html += '<optgroup label="🎨 All ShadSync Variables">';
          variableGroup.allShadSyncVariables.forEach(variable => {
            const isCurrentVariable = variable.id === variableGroup.currentVariable.id;
            const isInSuggestions = variableGroup.allSuggestions && 
              variableGroup.allSuggestions.some(s => s.id === variable.id);
            if (!isInSuggestions && !isCurrentVariable) {
              html += `<option value="${variable.id}">${variable.name}</option>`;
            } else if (isCurrentVariable) {
              html += `<option value="${variable.id}" style="color: #666; font-style: italic;">${variable.name} (current)</option>`;
            }
          });
          html += '</optgroup>';
        }
        
        html += `
                </select>
                <button class="replace-btn" id="replace-all-btn-${groupIndex}" data-group-index="${groupIndex}" data-select-id="select-all-group-${groupIndex}"
                        style="background: ${borderColor}; width: 100%;">
                  ${isShadsyncVariable ? 'Switch All' : 'Replace All'} ${variableGroup.objects.length} Objects
                </button>
              </div>
            </div>
            
            <!-- List of affected objects -->
            <div class="affected-objects" style="padding: 12px; background: #fafafa;">
              <div style="font-weight: 600; margin-bottom: 8px; color: #666;">Affected Objects:</div>
        `;
        
        // Show each affected object
        variableGroup.objects.forEach((obj, objIndex) => {
          const hasColor = obj.color && (obj.color.r !== undefined || obj.color.g !== undefined || obj.color.b !== undefined);
          const colorStyle = hasColor ? 
            `background: rgb(${Math.round((obj.color.r || 0) * 255)}, ${Math.round((obj.color.g || 0) * 255)}, ${Math.round((obj.color.b || 0) * 255)})` : 
            'background: #ccc';
          
          html += `
            <div class="object-item" style="display: flex; align-items: center; padding: 6px 0; border-bottom: 1px solid #eee;">
              <div class="color-preview" style="${colorStyle}; width: 16px; height: 16px; border-radius: 3px; margin-right: 8px; border: 1px solid #ddd;"></div>
              <span style="flex: 1;">${obj.node.name} (${obj.node.type})</span>
              <span style="font-size: 12px; color: #666; text-transform: capitalize;">${obj.property}</span>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      listDiv.innerHTML = html;
      
      // Store the grouped data for replacement functionality
      window.allVariableGroups = allVariableAssigned;
      
      // Add event listeners to replace buttons
      setTimeout(() => {
        allVariableAssigned.forEach((variableGroup, index) => {
          const button = document.getElementById(`replace-all-btn-${index}`);
          if (button) {
            console.log(`Adding event listener to all-variables button ${index}`);
            button.addEventListener('click', function() {
              console.log(`All-variables button ${index} clicked`);
              const buttonGroupIndex = parseInt(this.getAttribute('data-group-index'));
              const selectId = this.getAttribute('data-select-id');
              window.applyAllVariableGroupReplacement(buttonGroupIndex, selectId);
            });
          } else {
            console.error(`All-variables button not found: replace-all-btn-${index}`);
          }
        });
      }, 100);
    }

    // Display objects without variables
    function displayUnassignedObjects(unassignedObjects) {
      const listDiv = document.getElementById('unassigned-list');
      let html = '';
      
      unassignedObjects.forEach((item, index) => {
        const hasColor = item.color && (item.color.r !== undefined || item.color.g !== undefined || item.color.b !== undefined);
        const colorStyle = hasColor ? 
          `background: rgb(${Math.round((item.color.r || 0) * 255)}, ${Math.round((item.color.g || 0) * 255)}, ${Math.round((item.color.b || 0) * 255)})` : 
          'background: #ccc';
        
        html += `
          <div class="suggestion-item">
            <div class="suggestion-header">
              <div class="object-info">${item.node.name} (${item.node.type})</div>
            </div>
            <div class="current-variable">No variable assigned</div>
        `;
        
        if (item.allSuggestions && item.allSuggestions.length > 0) {
          html += `
            <div class="suggestion-row">
              <div class="color-preview" style="${colorStyle}"></div>
              <select class="select-dropdown" id="select-${index}-unassigned" onchange="updateSelectedVariable('${item.node.id}', '${item.property}', this.value, ${item.fillIndex || 0}, ${item.strokeIndex || 0})">
                <option value="">Choose shadsync variable...</option>
          `;
          
          item.allSuggestions.forEach(suggestion => {
            const selected = item.suggestion && suggestion.id === item.suggestion.id ? 'selected' : '';
            html += `<option value="${suggestion.id}" ${selected}>${suggestion.name} (${suggestion.score}% match)</option>`;
          });
          
          html += `
              </select>
              <button class="replace-btn" onclick="applySelectedVariable('${item.node.id}', '${item.property}', 'select-${index}-unassigned', ${item.fillIndex || 0}, ${item.strokeIndex || 0})">
                Apply
              </button>
            </div>
          `;
        } else {
          html += `
            <div class="no-suggestion">No matching shadsync variable found</div>
          `;
        }
        
        html += '</div>';
      });
      
      listDiv.innerHTML = html;
    }
    
    // Display usage summary
    function displayUsageSummary(variablesByCollection, mainCollectionName) {
      const listDiv = document.getElementById('variables-list');
      let html = '';
      
      Object.entries(variablesByCollection).forEach(([collectionName, variables]) => {
        const isMainCollection = collectionName === mainCollectionName;
        html += `
          <div class="collection-group">
            <div class="collection-title">
              ${collectionName} ${isMainCollection ? '(Main)' : ''}
              <span style="color: #666; font-weight: normal;">(${variables.length} variables)</span>
            </div>
            <div class="variables-list">
        `;
        
        variables.forEach(variable => {
          html += `
            <div class="variable-item">
              ${variable.name} <span style="color: #666;">(${variable.type})</span>
            </div>
          `;
        });
        
        html += '</div></div>';
      });
      
      listDiv.innerHTML = html;
    }
    
    // Replace variable function
    function replaceVariable(nodeId, property, newVariableId) {
      parent.postMessage({
        pluginMessage: {
          type: 'replace-variable',
          nodeId: nodeId,
          property: property,
          newVariableId: newVariableId
        }
      }, '*');
    }
    
    // Update selected variable in dropdown
    function updateSelectedVariable(nodeId, property, newVariableId, fillIndex, strokeIndex) {
      // This function can be used to provide immediate feedback
      console.log('Variable selected:', newVariableId);
    }
    
    // Apply selected variable from dropdown
    function applySelectedVariable(nodeId, property, selectId, fillIndex, strokeIndex) {
      const selectElement = document.getElementById(selectId);
      const newVariableId = selectElement.value;
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      parent.postMessage({
        pluginMessage: {
          type: 'replace-variable',
          nodeId: nodeId,
          property: property,
          newVariableId: newVariableId,
          fillIndex: fillIndex,
          strokeIndex: strokeIndex
        }
      }, '*');
    }

    // Make sure the function is available globally
    window.applyGroupReplacement = function(groupIndex, selectId) {
      console.log('applyGroupReplacement called:', groupIndex, selectId);
      console.log('Available functions:', typeof updateSelectedVariable, typeof applySelectedVariable);
      console.log('Window object keys:', Object.keys(window));
      
      const selectElement = document.getElementById(selectId);
      if (!selectElement) {
        console.error('Select element not found:', selectId);
        console.log('Available elements with select-group prefix:', document.querySelectorAll('[id^="select-group"]'));
        showStatus('Dropdown not found', 'error');
        return;
      }
      
      const newVariableId = selectElement.value;
      console.log('Selected variable ID:', newVariableId);
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      if (!window.nonShadSyncGroups || !window.nonShadSyncGroups[groupIndex]) {
        console.error('Group data not found:', window.nonShadSyncGroups, groupIndex);
        showStatus('Group data not found', 'error');
        return;
      }
      
      const group = window.nonShadSyncGroups[groupIndex];
      console.log('Processing group:', group);
      let replacementCount = 0;
      
      // Replace variable for each object in the group
      group.objects.forEach((obj, index) => {
        console.log(`Replacing object ${index + 1}:`, obj.node.id, obj.property, newVariableId);
        
        parent.postMessage({
          pluginMessage: {
            type: 'replace-variable',
            nodeId: obj.node.id,
            property: obj.property,
            newVariableId: newVariableId,
            fillIndex: obj.fillIndex || 0,
            strokeIndex: obj.strokeIndex || 0
          }
        }, '*');
        replacementCount++;
      });
      
      showStatus(`Replacing variable for ${replacementCount} objects...`, 'info');
      
      // Re-run detection after a short delay to update the UI
      setTimeout(() => {
        console.log('Re-running variable check...');
        parent.postMessage({
          pluginMessage: { type: 'check-variables' }
        }, '*');
      }, 1000);
    };

    // Apply group replacement for all variable-assigned objects
    window.applyAllVariableGroupReplacement = function(groupIndex, selectId) {
      console.log('applyAllVariableGroupReplacement called:', groupIndex, selectId);
      
      const selectElement = document.getElementById(selectId);
      if (!selectElement) {
        console.error('Select element not found:', selectId);
        showStatus('Dropdown not found', 'error');
        return;
      }
      
      const newVariableId = selectElement.value;
      console.log('Selected variable ID:', newVariableId);
      
      if (!newVariableId) {
        showStatus('Please select a variable first', 'error');
        return;
      }
      
      if (!window.allVariableGroups || !window.allVariableGroups[groupIndex]) {
        console.error('All-variable group data not found:', window.allVariableGroups, groupIndex);
        showStatus('Group data not found', 'error');
        return;
      }
      
      const group = window.allVariableGroups[groupIndex];
      console.log('Processing all-variable group:', group);
      let replacementCount = 0;
      
      // Replace variable for each object in the group
      group.objects.forEach((obj, index) => {
        console.log(`Replacing all-variable object ${index + 1}:`, obj.node.id, obj.property, newVariableId);
        
        parent.postMessage({
          pluginMessage: {
            type: 'replace-variable',
            nodeId: obj.node.id,
            property: obj.property,
            newVariableId: newVariableId,
            fillIndex: obj.fillIndex || 0,
            strokeIndex: obj.strokeIndex || 0
          }
        }, '*');
        replacementCount++;
      });
      
      showStatus(`Replacing variable for ${replacementCount} objects...`, 'info');
      
      // Re-run detection after a short delay to update the UI
      setTimeout(() => {
        console.log('Re-running variable check after all-variable replacement...');
        parent.postMessage({
          pluginMessage: { type: 'check-variables' }
        }, '*');
      }, 1000);
    };

    // Apply group replacement for all variable-assigned objects
    function applyAllVariableGroupReplacement(groupIndex, selectId) {
      return window.applyAllVariableGroupReplacement(groupIndex, selectId);
    }

    // Apply group replacement - replace variable for all objects in a group
    function applyGroupReplacement(groupIndex, selectId) {
      return window.applyGroupReplacement(groupIndex, selectId);
    }

    // Initialize when page loads
    window.addEventListener('load', function() {
      console.log('Page loaded. Available functions:');
      console.log('- applyGroupReplacement:', typeof applyGroupReplacement);
      console.log('- applySelectedVariable:', typeof applySelectedVariable);
      console.log('- updateSelectedVariable:', typeof updateSelectedVariable);
    });
  </script>
</body>
</html>
